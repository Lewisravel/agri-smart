{% extends "base.html" %}
{% load i18n static %}

{% block title %}{% trans "Chatbot Agricole" %} - Agri Smart{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-robot"></i> {% trans "Assistant Agricole IA" %}
                </h4>
                <small>{% trans "Posez vos questions sur l'agriculture" %}</small>
            </div>
            <div class="card-body p-0">
                <!-- Zone de chat -->
                <div id="chat-messages" class="p-4" style="height: 500px; overflow-y: auto; background-color: #f8f9fa;">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>{% trans "Bienvenue! Posez-moi des questions sur l'agriculture." %}</p>
                        <p class="small">
                            {% trans "Exemples:" %}<br>
                            • Comment cultiver le maïs?<br>
                            • Quelle est la meilleure période pour planter?<br>
                            • Comment traiter les maladies des tomates?
                        </p>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-white">
                <form id="chat-form" class="d-flex gap-2">
                    <input type="text" 
                           id="chat-input" 
                           class="form-control" 
                           placeholder="{% trans 'Tapez votre question...' %}"
                           autocomplete="off">
                    <button type="submit" class="btn btn-primary" id="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i> 
                    {% trans "Appuyez sur Entrée pour envoyer" %}
                </small>
            </div>
        </div>
        
        <div class="alert alert-info mt-3">
            <i class="fas fa-lightbulb"></i>
            <strong>{% trans "Astuce:" %}</strong>
            {% trans "Le chatbot utilise l'IA pour répondre à vos questions sur l'agriculture. Les réponses sont basées sur des données agricoles réelles." %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    
    // Connexion WebSocket (optionnelle)
    let socket = null;
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    
    try {
        socket = new WebSocket(protocol + '//' + window.location.host + '/ws/chat/');
        
        socket.onopen = function(e) {
            console.log('WebSocket connecté');
        };
        
        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            addMessage(data.message, 'bot');
        };
        
        socket.onerror = function(e) {
            console.log('WebSocket erreur, utilisation du mode HTTP');
        };
        
        socket.onclose = function(e) {
            console.log('WebSocket fermé');
        };
    } catch (error) {
        console.log('WebSocket non disponible, utilisation du mode HTTP');
    }
    
    // Gestion du formulaire
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const message = chatInput.value.trim();
        if (!message) return;
        
        // Ajouter le message de l'utilisateur
        addMessage(message, 'user');
        chatInput.value = '';
        
        // Désactiver le bouton pendant le traitement
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        // Envoyer via WebSocket ou HTTP
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                'message': message
            }));
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        } else {
            // Mode HTTP fallback
            sendMessageHTTP(message);
        }
    });
    
    // Fonction pour envoyer via HTTP
    function sendMessageHTTP(message) {
        fetch('/api/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            addMessage(data.response || data.message || 'Réponse reçue', 'bot');
        })
        .catch(error => {
            console.error('Erreur:', error);
            addMessage('Désolé, je rencontre un problème. Veuillez réessayer.', 'bot');
        })
        .finally(() => {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        });
    }
    
    // Fonction pour ajouter un message
    function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-3 ${sender === 'user' ? 'text-end' : ''}`;
        
        const bubble = document.createElement('div');
        bubble.className = `d-inline-block p-3 rounded ${
            sender === 'user' 
                ? 'bg-primary text-white' 
                : 'bg-white border'
        }`;
        bubble.style.maxWidth = '70%';
        
        if (sender === 'bot') {
            const icon = document.createElement('i');
            icon.className = 'fas fa-robot me-2';
            bubble.appendChild(icon);
        }
        
        const textNode = document.createTextNode(text);
        bubble.appendChild(textNode);
        
        messageDiv.appendChild(bubble);
        chatMessages.appendChild(messageDiv);
        
        // Scroll vers le bas
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Fonction pour obtenir le token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}